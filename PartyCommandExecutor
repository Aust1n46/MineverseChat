package mineverse.Aust1n46.chat.command;

import java.util.logging.Logger;
import mineverse.Aust1n46.chat.ChatChannelInfo;
import mineverse.Aust1n46.chat.MineverseChat;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.metadata.FixedMetadataValue;

public class PartyCommandExecutor implements CommandExecutor {
	private MineverseChat plugin;
	ChatChannelInfo cc;
	private static final Logger log = Logger.getLogger("Minecraft");
	
	public PartyCommandExecutor(MineverseChat _plugin, ChatChannelInfo _cc) {
		plugin = _plugin;
		cc = _cc;
	}
	@Override
	public boolean onCommand(CommandSender sender, Command cmd, String label, String[] args) {	
		String comm = cmd.getName().toLowerCase();
		if(!(sender instanceof Player)) {
    		log.info(String.format("[" + String.format(plugin.getConfig().getString("pluginname", "MineverseChat") + "]" + " - This command must be run by a player!", plugin.getDescription().getName())));
    		return true;
    	}
        Player player = (Player) sender;       
        
        if(args == null) {
            return false;
        }
        
        switch (comm) {
        	case "party": {
        		try {       	        			
        			switch(args[0]) {
        				case "host": {
        					if(plugin.getMetadata(player, "MineverseChat.party.host", plugin)) {
        						player.setMetadata("MineverseChat.party.host", new FixedMetadataValue(plugin,false));
        						player.sendMessage(ChatColor.GREEN + "You are no longer hosting a party.");
        						player.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,""));
        						for(Player h : Bukkit.getOnlinePlayers()) {
        							if(plugin.getMetadataString(h, "MineverseChat.party", plugin).equals(player.getName())) {
        								h.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,""));
        								h.sendMessage(ChatColor.RED + player.getName() + " is no longer hosting a party.");
        							}
        						}
        						break;
        					}
        					player.setMetadata("MineverseChat.party.host", new FixedMetadataValue(plugin,true));
        					player.sendMessage(ChatColor.GREEN + "You are now hosting a party.");
        					player.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,player.getName()));
        					break;
        				}
        				case "join": {
        					if(args.length > 1) {
        						Player tp = Bukkit.getPlayer(args[1]);
        						if(tp != null) {
        							if(plugin.getMetadata(tp, "MineverseChat.party.host", plugin)) {
        								if(plugin.getMetadataString(player, "MineverseChat.party", plugin).equals("")) {
        									player.sendMessage(ChatColor.GREEN + "Joined " + tp.getName() + "'s party.");
        									player.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,tp.getName()));
        									tp.sendMessage(ChatColor.GREEN + player.getName() + " joined your party.");
        									break;
        								}
        								player.sendMessage(ChatColor.RED + "You are already in " + plugin.getMetadataString(player, "MineverseChat.party", plugin) + "'s party.");
        								break;
        							}
        							player.sendMessage(ChatColor.RED + tp.getName() + " is not hosting a party.");
        							break;
        						}
        						player.sendMessage(ChatColor.RED + "Player " + ChatColor.GOLD + args[1] + ChatColor.RED + " is not online.");
        						break;
        					}
        					player.sendMessage(ChatColor.RED + "Invalid command: /party join [player]");
        					break;
        				}
        				case "leave": {
        					if(!plugin.getMetadataString(player, "MineverseChat.party", plugin).equals("")) {
        						player.setMetadata("MineverseChat.party.host", new FixedMetadataValue(plugin,false));
        						player.sendMessage(ChatColor.GREEN + "Leaving " + plugin.getMetadataString(player, "MineverseChat.party", plugin) + "'s party.");
        						player.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,""));
        						for(Player h : Bukkit.getOnlinePlayers()) {
        							if(plugin.getMetadataString(h, "MineverseChat.party", plugin).equals(player.getName())) {
        								h.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,""));
        								h.sendMessage(ChatColor.RED + player.getName() + " is no longer hosting a party.");
        							}
        						}
        						break;
        					}
        					player.sendMessage(ChatColor.RED + "You are not in a party.");
        					break;
        				}
        				case "kick": {
        					if(plugin.getMetadata(player, "MineverseChat.party.host", plugin)) {
        						if(args.length > 1) {
        							Player tp = Bukkit.getPlayer(args[1]);
            						if(tp != null) {
            							if(!tp.getName().equals(player.getName())) {
            								if(plugin.getMetadataString(tp, "MineverseChat.party", plugin).equals(player.getName())) {
            									tp.setMetadata("MineverseChat.party", new FixedMetadataValue(plugin,""));
            									tp.sendMessage(ChatColor.RED + "You have been kicked out of " + player.getName() + "'s party.");
            									player.sendMessage(ChatColor.RED + "You have kicked " + tp.getName() + " out of your party.");
            									break;          	
            								}
            								player.sendMessage(ChatColor.RED + "Player " + tp.getName() + " is not in your party.");
            								break;
            							}
            							player.sendMessage(ChatColor.RED + "You cannot kick yourself.");
            							break;
            						}
            						player.sendMessage(ChatColor.RED + "Player " + ChatColor.GOLD + args[1] + ChatColor.RED + " is not online.");
            						break;
        						}
        						player.sendMessage(ChatColor.RED + "Invalid command: /party kick [playername]");
            					break;
        					}
        					player.sendMessage(ChatColor.RED + "You are not hosting a party.");
        					break;
        				}
        				case "info": {
        					if(!plugin.getMetadataString(player, "MineverseChat.party", plugin).equals("")) {
        						player.sendMessage(ChatColor.GREEN + "You are in " + plugin.getMetadataString(player, "MineverseChat.party", plugin) + "'s party.");
        					}
        					else if(plugin.getMetadata(player, "MineverseChat.party.host", plugin)) {
        						player.sendMessage(ChatColor.GREEN + "You are hosting a party.");
        					}
        					else {
        						player.sendMessage(ChatColor.RED + "You are not hosting a party and you are not in a party.");
        					}
        					if(plugin.getMetadata(player, "MineverseChat.party.chat", plugin)) {
        						player.sendMessage(ChatColor.GREEN + "Party chat on.");
        						break;
        					}
        					player.sendMessage(ChatColor.GREEN + "Party chat off.");
        					break;
        				}
        				case "chat": {
        					if(plugin.getMetadata(player, "MineverseChat.party.chat", plugin)) {
        						player.setMetadata("MineverseChat.party.chat", new FixedMetadataValue(plugin,false));
        						player.sendMessage(ChatColor.GREEN + "Toggled party chat off.");
        						break;
        					}
        					String tellchat = plugin.getMetadataString(player, "MineverseChat.tell", plugin);
        					if(tellchat.length() > 0) {
        						player.setMetadata("MineverseChat.tell", new FixedMetadataValue(plugin, ""));
        	                    Player pl[] = plugin.getServer().getOnlinePlayers();
        	                    for(Player sp : pl) {
        							if(plugin.getMetadata(sp,"MineverseChat.spy", plugin) == true) {         					
        								sp.sendMessage(player.getDisplayName() + " is no longer in a private conversation with " + tellchat + ".");
        							}							
        						}
        	                    player.sendMessage("You are no longer in private conversation with " + tellchat);
        					}
        					player.setMetadata("MineverseChat.party.chat", new FixedMetadataValue(plugin,true));
    						player.sendMessage(ChatColor.GREEN + "Toggled party chat on.");
    						break;     					
        				}
        				case "help": {
        					player.sendMessage(ChatColor.GREEN + "/party host\n/party join [player]\n/party leave\n/party kick [player]\n/party info\n/party members [player]\n/party chat\n/party help");
        					break;
        				}
        				case "members": {
        					if(args.length > 1) {
        						Player tp = Bukkit.getPlayer(args[1]);
        						if(tp != null) {
        							if(plugin.getMetadata(tp, "MineverseChat.party.host", plugin)) {
        								String members="";
        								long linecount = plugin.getLineLength();
        								for(Player m : Bukkit.getOnlinePlayers()) {
        									if(plugin.getMetadataString(m, "MineverseChat.party", plugin).equals(tp.getName())) {
        										if(members.length() + m.getName().length() > linecount) {
        											members += "\n";
        											linecount = linecount + plugin.getLineLength();
        										}
        										members += m.getName() + ", ";
        									}
        								}
        								if(members.length() > 2) {
        									members = members.substring(0, members.length() - 2);
        								}
        								player.sendMessage(ChatColor.GREEN + "Members in " + tp.getName() + "'s party: " + members);
        								break;
        							}
        							player.sendMessage(ChatColor.RED + "Player " + tp.getName() + " is not hosting a party.");
        							break;
        						}
        						player.sendMessage(ChatColor.RED + "Player " + ChatColor.GOLD + args[1] + ChatColor.RED + " is not online.");
        						break;
        					}
        					player.sendMessage(ChatColor.RED + "Invalid command: /party members [player]");
        					break;
        				} 
        			}
        			if(args[0].length() > 0) {
        				if(!args[0].equals("host") && !args[0].equals("join") && !args[0].equals("leave") && !args[0].equals("kick") && !args[0].equals("info") && !args[0].equals("chat") && !args[0].equals("help") && !args[0].equals("members")) {
        					if(!plugin.getMetadataString(player, "MineverseChat.party", plugin).equals("")) {
        						String msg = "";
        						String partyformat = "";
        						for(int x = 0; x < args.length; x++) {
        							if(args[x].length() > 0) msg += " " + args[x];
        						}          			
        						if(plugin.getMetadata(player, "MineverseChat.filter", plugin)) {
        							msg = cc.FilterChat(msg);
        						}       
        						if(player.isPermissionSet("mineversechat.color")) {
         		                    msg = cc.FormatStringColor(msg);
        						}
        						if(player.isPermissionSet("mineversechat.format")) {
         		                    msg = cc.FormatString(msg);
        						}
        						if(plugin.getConfig().getString("partyformat").equalsIgnoreCase("Default")) {
                					partyformat = ChatColor.GREEN + "[" + plugin.getMetadataString(player, "MineverseChat.party", plugin) + "'s Party] " +player.getName() + ":" + msg;
                				}
                				else {
                					partyformat = cc.FormatStringAll(plugin.getConfig().getString("partyformat").replace("{host}", plugin.getMetadataString(player, "MineverseChat.party", plugin)).replace("{player}", player.getName())) + msg;
                				}
        						for(Player party : Bukkit.getOnlinePlayers()) {
        							if(plugin.getMetadataString(party, "MineverseChat.party", plugin).equals(plugin.getMetadataString(player, "MineverseChat.party", plugin)) || plugin.getMetadata(party,"MineverseChat.spy", plugin)) {   								
        								party.sendMessage(partyformat);
        							}
        						}
        					}
        					else {
        						player.sendMessage(ChatColor.RED + "You are not in a party.");
        					}
        				}
        			}
        		}
        		catch(Exception e) {
					player.sendMessage(ChatColor.RED + "Invalid arguments, /party help");
				}
				return true;
        	}
        }
		return false;
	}
}
